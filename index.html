<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تحديث بيانات سكان أبراج العودة</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#06b6d4; --danger:#ef4444; --border:#1f2937; }
    *{box-sizing:border-box}
    body{ margin:0; background:linear-gradient(135deg,#0b1225,#0f172a 50%,#0b1225); font-family: "Cairo", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; color:var(--text); }
    .container{ max-width: 1000px; margin: 40px auto; padding: 0 16px; }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:24px; }
    .title{ font-size: 26px; font-weight: 800; letter-spacing: 0.3px; background: linear-gradient(90deg, #22c55e, #06b6d4); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .card{ background: rgba(17,24,39,0.7); backdrop-filter: blur(6px); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; box-shadow: 0 20px 45px rgba(0,0,0,0.35); }
    .card-header{ padding: 18px 20px; border-bottom: 1px solid var(--border); display:flex; align-items:center; gap:12px; }
    .badge{ padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight:700; background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.35); color:#86efac; }
    .sub{ color: var(--muted); font-size: 13px; }
    form{ padding: 20px; display:grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .field{ grid-column: span 6; display:flex; flex-direction:column; gap:8px; }
    .field.full{ grid-column: 1 / -1; }
    .label{ font-size: 13px; color: #cbd5e1; display:flex; align-items:center; gap:8px; }
    .req{ font-size: 11px; color:#22c55e; border:1px solid rgba(34,197,94,0.35); border-radius:999px; padding: 2px 8px; background: rgba(34,197,94,0.1); }
    .opt{ font-size: 11px; color:#06b6d4; border:1px solid rgba(6,182,212,0.35); border-radius:999px; padding: 2px 8px; background: rgba(6,182,212,0.08); }
    input, select, textarea{ width: 100%; padding: 12px 14px; border-radius: 10px; background: #0b1324; border: 1px solid #1f2937; color: var(--text); outline: none; transition: border-color .2s, box-shadow .2s; }
    input:focus, select:focus, textarea:focus{ border-color: #22c55e; box-shadow: 0 0 0 3px rgba(34,197,94,0.15); }
    .hint{ color: var(--muted); font-size: 12px; }
    .error{ color:#fecaca; background: rgba(239,68,68,0.08); border:1px solid rgba(239,68,68,0.35); padding:8px 10px; border-radius:8px; font-size: 12px; display:none; }
    .actions{ padding: 0 20px 20px; display:flex; gap:12px; justify-content:flex-start; align-items:center; }
    .btn{ padding: 12px 16px; border-radius: 10px; border:1px solid #1f2937; cursor:pointer; font-weight:700; transition: transform .05s ease, box-shadow .2s; background:#0b1324; color:var(--text); }
    .btn:active{ transform: translateY(1px); }
    .primary{ background: linear-gradient(90deg,#22c55e,#06b6d4); color:#0b1224; border:none; }
    .secondary{ background: #0b1324; color: var(--text); }
    .admin-indicator{ font-size:13px; color:#c7f9d4; background: rgba(34,197,94,0.08); padding:6px 10px; border-radius:8px; border:1px solid rgba(34,197,94,0.12); display:none; }
    .table-wrap{ padding: 20px; border-top:1px solid var(--border); }
    table{ width:100%; border-collapse: collapse; font-size: 13px; border:1px solid var(--border); overflow: auto; }
    th, td{ border-bottom:1px solid var(--border); padding:10px; text-align:center; }
    th{ background: #0d162b; color:#a7f3d0; position: sticky; top:0; }
    @media (max-width: 850px){ .field{ grid-column: span 12; } .actions{ flex-wrap:wrap } }
    footer{ text-align:center; color: var(--muted); padding: 18px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">تحديث بيانات سكان أبراج العودة</div>
      <span class="badge">نموذج حديث</span>
    </div>

    <div class="card" id="app">
      <div class="card-header">
        <div>
          <div style="font-weight:700">يرجى تعبئة الحقول بدقة</div>
          <div class="sub">لن يُقبل أي إدخال دون استيفاء الشروط، وأرقام الهوية غير المكررة إلزامياً.</div>
        </div>
      </div>

      <form id="form">
        <!-- الحقول كما في النسخة السابقة -->
        <div class="field">
          <label class="label">الاسم الرباعي <span class="req">إجباري</span></label>
          <input type="text" id="fullName" required placeholder="مثال: محمد أحمد علي عثمان" />
          <div class="hint">اكتب الاسم الرباعي كاملاً.</div>
          <div class="error" id="err-fullName"></div>
        </div>

        <div class="field">
          <label class="label">رقم الهوية <span class="req">إجباري</span></label>
          <input type="text" id="idNumber" inputmode="numeric" pattern="\d{9}" maxlength="9" required placeholder="9 أرقام" />
          <div class="hint">يجب أن يكون 9 أرقام، وغير مكرر.</div>
          <div class="error" id="err-idNumber"></div>
        </div>

        <div class="field">
          <label class="label">اسم الزوجة الرباعي <span class="req">إجباري</span></label>
          <input type="text" id="wifeName" required placeholder="مثال: فاطمة خالد حسين سالم" />
          <div class="hint">اكتب الاسم الرباعي كاملاً.</div>
          <div class="error" id="err-wifeName"></div>
        </div>

        <div class="field">
          <label class="label">رقم هوية الزوجة <span class="req">إجباري</span></label>
          <input type="text" id="wifeIdNumber" inputmode="numeric" pattern="\d{9}" maxlength="9" required placeholder="9 أرقام" />
          <div class="hint">يجب أن يكون 9 أرقام، وغير مكرر.</div>
          <div class="error" id="err-wifeIdNumber"></div>
        </div>

        <div class="field">
          <label class="label">رقم الجوال <span class="req">إجباري</span></label>
          <input type="text" id="phone" inputmode="numeric" pattern="\d{10}" maxlength="10" required placeholder="10 أرقام" />
          <div class="hint">10 أرقام بالضبط.</div>
          <div class="error" id="err-phone"></div>
        </div>

        <div class="field">
          <label class="label">رقم الجوال البديل <span class="opt">اختياري</span></label>
          <input type="text" id="altPhone" inputmode="numeric" pattern="\d{10}" maxlength="10" placeholder="10 أرقام" />
          <div class="hint">اختياري، إن وُجد.</div>
          <div class="error" id="err-altPhone"></div>
        </div>

        <div class="field">
          <label class="label">رقم البرج <span class="req">إجباري</span></label>
          <select id="tower" required>
            <option value="">اختر من 1 إلى 8</option>
            <option>1</option><option>2</option><option>3</option><option>4</option>
            <option>5</option><option>6</option><option>7</option><option>8</option>
          </select>
          <div class="error" id="err-tower"></div>
        </div>

        <div class="field">
          <label class="label">رقم الشقة <span class="req">إجباري</span></label>
          <input type="text" id="apartment" inputmode="numeric" pattern="\d{3}" maxlength="3" required placeholder="3 أرقام" />
          <div class="hint">3 أرقام بالضبط (مثال: 012 أو 101).</div>
          <div class="error" id="err-apartment"></div>
        </div>

        <div class="field">
          <label class="label">محافظة السكن <span class="req">إجباري</span></label>
          <select id="governorate" required>
            <option value="">اختر المحافظة</option>
            <option>رفح</option>
            <option>خانيونس</option>
            <option>الوسطى</option>
            <option>غزة</option>
            <option>شمال غزة</option>
          </select>
          <div class="error" id="err-governorate"></div>
        </div>

        <div class="field full">
          <label class="label">العنوان التفصيلي <span class="req">إجباري</span></label>
          <textarea id="address" rows="2" required placeholder="وصف العنوان بدقة"></textarea>
          <div class="error" id="err-address"></div>
        </div>

        <div class="field full">
          <label class="label">الملاحظات <span class="opt">اختياري</span></label>
          <textarea id="notes" rows="2" placeholder="أي تفاصيل إضافية"></textarea>
        </div>
      </form>

      <div class="actions">
        <button type="button" class="btn primary" id="submitBtn">إدخال</button>
        <button type="button" class="btn secondary" id="adminLoginBtn">دخول المدير</button>
        <div id="adminIndicator" class="admin-indicator" role="status" aria-live="polite">مدير مسجّل</div>
        <button type="button" class="btn secondary" id="exportCsvBtn" style="display:none">تصدير CSV</button>
        <button type="button" class="btn secondary" id="clearAllBtn" style="display:none">مسح الكل</button>
      </div>

      <div class="table-wrap">
        <div class="sub" style="margin-bottom:8px">البيانات محفوظة آمنًا على الخادم (يتطلب الوصول صلاحية المدير لتصدير/مسح).</div>
        <div style="overflow:auto; max-height: 360px;">
          <table id="dataTable">
            <thead>
              <tr>
                <th>الاسم الرباعي</th>
                <th>رقم الهوية</th>
                <th>اسم الزوجة</th>
                <th>رقم هوية الزوجة</th>
                <th>رقم الجوال</th>
                <th>رقم الجوال البديل</th>
                <th>رقم البرج</th>
                <th>رقم الشقة</th>
                <th>المحافظة</th>
                <th>العنوان التفصيلي</th>
                <th>الملاحظات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <footer>تم التصميم بتنسيق حديث ومتوافق مع الأجهزة المحمولة.</footer>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // ضع قيم Supabase الحقيقية كمتغيرات بيئية في Netlify.
    const SUPABASE_URL = 'REPLACE_WITH_SUPABASE_URL'
    const SUPABASE_ANON_KEY = 'REPLACE_WITH_SUPABASE_ANON_KEY'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const submitBtn = document.getElementById('submitBtn')
    const adminLoginBtn = document.getElementById('adminLoginBtn')
    const exportCsvBtn = document.getElementById('exportCsvBtn')
    const clearAllBtn = document.getElementById('clearAllBtn')
    const adminIndicator = document.getElementById('adminIndicator')
    const tableBody = document.querySelector('#dataTable tbody')
    const form = document.getElementById('form')

    const showError = (id, msg) => { const el = document.getElementById(id); el.textContent = msg; el.style.display = 'block'; }
    const clearError = (id) => { const el = document.getElementById(id); el.textContent = ''; el.style.display = 'none'; }

    const isNineDigits = v => /^\d{9}$/.test(v)
    const isTenDigits = v => /^\d{10}$/.test(v)
    const isThreeDigits = v => /^\d{3}$/.test(v)
    const notEmpty = v => (v||'').trim().length>0

    const loadTable = async () => {
      try {
        const { data, error } = await supabase.from('submissions').select('*').order('created_at', { ascending: true }).limit(500)
        if (error) return console.warn('Could not fetch table for display:', error)
        tableBody.innerHTML = ''
        data.forEach(r => {
          const tr = document.createElement('tr')
          [r.full_name, r.id_number, r.wife_name, r.wife_id_number, r.phone, r.alt_phone || '', r.tower, r.apartment, r.governorate, r.address, r.notes || '']
            .forEach(cell => { const td = document.createElement('td'); td.textContent = cell; tr.appendChild(td) })
          tableBody.appendChild(tr)
        })
      } catch (err) { console.error(err) }
    }

    const setAdminUI = (user) => {
      const isAdmin = !!user
      exportCsvBtn.style.display = isAdmin ? '' : 'none'
      clearAllBtn.style.display = isAdmin ? '' : 'none'
      adminIndicator.style.display = isAdmin ? 'inline-block' : 'none'
      adminLoginBtn.textContent = isAdmin ? 'خروج المدير' : 'دخول المدير'
    }

    const initAuth = async () => {
      const { data: { session }, error } = await supabase.auth.getSession()
      if (session && session.access_token) {
        setAdminUI(session.user)
      } else {
        setAdminUI(null)
      }
    }

    initAuth()
    loadTable()

    submitBtn.addEventListener('click', async (e) => {
      e.preventDefault()
      const fullName = document.getElementById('fullName').value.trim()
      const idNumber = document.getElementById('idNumber').value.trim()
      const wifeName = document.getElementById('wifeName').value.trim()
      const wifeIdNumber = document.getElementById('wifeIdNumber').value.trim()
      const phone = document.getElementById('phone').value.trim()
      const altPhone = document.getElementById('altPhone').value.trim()
      const tower = document.getElementById('tower').value.trim()
      const apartment = document.getElementById('apartment').value.trim()
      const governorate = document.getElementById('governorate').value.trim()
      const address = document.getElementById('address').value.trim()
      const notes = document.getElementById('notes').value.trim()

      ['fullName','idNumber','wifeName','wifeIdNumber','phone','altPhone','tower','apartment','governorate','address']
        .forEach(k => clearError('err-'+k))

      let ok = true
      if(!notEmpty(fullName)){ showError('err-fullName','الاسم الرباعي إجباري.'); ok=false }
      if(!isNineDigits(idNumber)){ showError('err-idNumber','رقم الهوية يجب أن يكون 9 أرقام.'); ok=false }
      if(!notEmpty(wifeName)){ showError('err-wifeName','اسم الزوجة الرباعي إجباري.'); ok=false }
      if(!isNineDigits(wifeIdNumber)){ showError('err-wifeIdNumber','رقم هوية الزوجة يجب أن يكون 9 أرقام.'); ok=false }
      if(!isTenDigits(phone)){ showError('err-phone','رقم الجوال يجب أن يكون 10 أرقام.'); ok=false }
      if(altPhone && !isTenDigits(altPhone)){ showError('err-altPhone','رقم الجوال البديل يجب أن يكون 10 أرقام.'); ok=false }
      if(!notEmpty(tower)){ showError('err-tower','رقم البرج إجباري.'); ok=false }
      if(!isThreeDigits(apartment)){ showError('err-apartment','رقم الشقة يجب أن يكون 3 أرقام.'); ok=false }
      if(!notEmpty(governorate)){ showError('err-governorate','المحافظة إجباري.'); ok=false }
      if(!notEmpty(address)){ showError('err-address','العنوان التفصيلي إجباري.'); ok=false }
      if(isNineDigits(idNumber) && isNineDigits(wifeIdNumber) && idNumber === wifeIdNumber){ showError('err-wifeIdNumber','لا يجوز تكرار رقم الهوية بين الزوج والزوجة.'); ok=false }
      if(!ok) return

      try {
        const { error } = await supabase.from('submissions').insert([{ full_name: fullName, id_number: idNumber, wife_name: wifeName, wife_id_number: wifeIdNumber, phone, alt_phone: altPhone || null, tower: parseInt(tower,10), apartment, governorate, address, notes: notes || null }])
        if (error) { console.error(error); alert('حدث خطأ أثناء الإدخال.'); return }
        alert('تم إدخال البيانات بنجاح.')
        form.reset()
        loadTable()
      } catch (err) { console.error(err); alert('خطأ غير متوقع.') }
    })

    adminLoginBtn.addEventListener('click', async () => {
      const { data: { session } } = await supabase.auth.getSession()
      if (session && session.user) {
        await supabase.auth.signOut()
        setAdminUI(null)
        alert('تم تسجيل خروج المدير.')
        return
      }

      const email = prompt('أدخل بريد المدير:')
      if (!email) return
      const password = prompt('أدخل كلمة المرور:')
      if (password === null) return
      const { data, error } = await supabase.auth.signInWithPassword({ email, password })
      if (error) { alert('فشل تسجيل الدخول: ' + (error.message||error)); return }
      setAdminUI(data.user)
      alert('تم تسجيل دخول المدير.')
    })

    exportCsvBtn.addEventListener('click', async () => {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session || !session.access_token) { alert('الرجاء تسجيل الدخول كمدير أولاً.'); return }
      try {
        const res = await fetch('/.netlify/functions/exportCsv', { headers: { Authorization: 'Bearer ' + session.access_token } })
        if (!res.ok) { const txt = await res.text(); alert('فشل التصدير: ' + txt); return }
        const blob = await res.blob()
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'abraj-export.csv'
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
      } catch (err) { console.error(err); alert('خطأ عند محاولة التصدير.') }
    })

    clearAllBtn.addEventListener('click', async () => {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session || !session.access_token) { alert('الرجاء تسجيل الدخول كمدير أولاً.'); return }
      if (!confirm('هل تريد مسح كل البيانات؟ لا يمكن التراجع.')) return
      try {
        const res = await fetch('/.netlify/functions/clearAll', { method: 'POST', headers: { Authorization: 'Bearer ' + session.access_token } })
        if (!res.ok) { const txt = await res.text(); alert('فشل المسح: ' + txt); return }
        alert('تم المسح.')
        loadTable()
      } catch (err) { console.error(err); alert('خطأ عند محاولة المسح.') }
    })

  </script>
</body>
</html>